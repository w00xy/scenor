# Микросервисная архитектура для ai.scenor.ru

## Обзор

В текущем состоянии приложение реализовано как монолит, но спроектировано с учетом будущей миграции на микросервисную архитектуру. Ниже описана стратегия разделения монолита на независимые микросервисы.

## Текущая архитектура (Монолит)

```
┌─────────────────────────┐
│              Монолит                    │
│  ┌─────────────┐ ┌──────────────────┐   │
│  │Auth Service │ │Scenario Service  │   │
│  └─────────────┘ └──────────────────┘   │
│  ┌─────────────┐ ┌──────────────────┐   │
│  │AI Service   │ │Notification      │   │
│  └─────────────┘ │Service           │   │
│                ┌──────────────────┐   │
│                │Database Service  │   │
│                └──────────────────┘   │
└─────────────────────────────────┘
```

## Целевая архитектура (Микросервисы)

```
┌─────────────────────────────────────────────────────────┐
│                    API Gateway                                │
└─────────────────┬───────────────────────────────────────────────┘
                  │
    ┌─────────────┼─────────────┐
    │             │             │
┌───▼───┐   ┌───▼───┐   ┌───▼────────┐
│Auth   │   │Scenario│   │AI Service│
│Service│   │Service │   │          │
└───────┘   └───────┘   └──────────┘
    │             │             │
    │             │             │
┌───▼───┐   ┌───▼───┐   ┌───▼────────┐
│User   │   │Scenario│   │OpenAI API│
│DB     │   │DB     │   │          │
└───────┘   └───────┘   └──────────┘
```

## Микросервисы

### 1. Auth Service

**Ответственность:**
- Аутентификация и авторизация пользователей
- Управление сессиями
- Работа с JWT токенами

**Технологии:**
- FastAPI
- PostgreSQL

**API endpoints:**
- `POST /auth/register` - регистрация пользователя
- `POST /auth/login` - вход пользователя
- `POST /auth/refresh` - обновление токена
- `GET /auth/me` - получение информации о текущем пользователе

**Сообщения в шине данных:**
- `user_registered` - уведомление о регистрации нового пользователя
- `user_logged_in` - уведомление о входе пользователя

### 2. User Service

**Ответственность:**
- Управление профилями пользователей
- Хранение пользовательских настроек

**Технологии:**
- FastAPI
- PostgreSQL

**API endpoints:**
- `GET /users/{id}` - получение информации о пользователе
- `PUT /users/{id}` - обновление информации о пользователе
- `GET /users/profile` - получение профиля текущего пользователя

### 3. Scenario Service

**Ответственность:**
- Управление сценариями
- Хранение сценариев и черновиков

**Технологии:**
- FastAPI
- PostgreSQL
- Redis (для кэширования)

**API endpoints:**
- `GET /scenarios` - получение списка сценариев пользователя
- `POST /scenarios` - создание сценария
- `PUT /scenarios/{id}` - обновление сценария
- `DELETE /scenarios/{id}` - удаление сценария
- `GET /scenarios/{id}` - получение сценария
- `POST /scenarios/{id}/share` - поделиться сценарием

### 4. AI Service

**Ответственность:**
- Генерация сценариев с помощью ИИ
- Обработка промптов
- Взаимодействие с внешними ИИ API

**Технологии:**
- FastAPI
- OpenAI API / аналоги
- Redis (для очередей задач)

**API endpoints:**
- `POST /ai/generate` - генерация сценария
- `POST /ai/generate/title` - генерация заголовка

### 5. Notification Service

**Ответственность:**
- Управление уведомлениями
- Отправка email/SMS/веб-уведомлений
- Обработка событий из шины данных

**Технологии:**
- FastAPI
- PostgreSQL
- Redis
- RabbitMQ

**API endpoints:**
- `POST /notifications` - создание уведомления
- `GET /notifications` - получение уведомлений пользователя

## Инфраструктура

### Шина сообщений

**RabbitMQ или Apache Kafka** для асинхронной коммуникации между сервисами:

- `user_events` - события, связанные с пользователями
- `scenario_events` - события, связанные со сценариями
- `ai_events` - события, связанные с ИИ генерацией
- `notification_events` - события для уведомлений

### Service Discovery

**Consul или Eureka** для обнаружения сервисов:
- Регистрация и обнаружение сервисов
- Проверка состояния сервисов
- Конфигурация сервисов

### Load Balancer

**NGINX** для балансировки нагрузки:
- Распределение запросов между экземплярами сервисов
- SSL терминация
- Аутентификация на уровне шлюза

## Миграция с монолита

### Фаза 1: Подготовка
1. Извлечение Auth Service из монолита
2. Настройка шины сообщений
3. Создание API Gateway

### Фаза 2: Миграция основных функций
1. Извлечение Scenario Service
2. Извлечение AI Service
3. Извлечение Notification Service

### Фаза 3: Дополнительные сервисы
1. Извлечение Template Service
2. Извлечение User Service
3. Оптимизация взаимодействий

## Безопасность

### Межсервисная аутентификация
- Использование JWT токенов для аутентификации между сервисами
- TLS шифрование для всех внутренних коммуникаций

### Защита API
- API Gateway как единая точка входа
- Rate limiting на уровне шлюза
- Валидация входных данных в каждом сервисе

## Мониторинг и логирование

### Логирование
- Единая система логирования (ELK Stack)
- Логирование в формате JSON
- Распределенные трейсы с уникальными ID

### Метрики
- Prometheus для сбора метрик
- Grafana для визуализации
- Алерты на основе метрик

### Алертинг
- Оповещения о сбоях сервисов
- Мониторинг производительности
- SLA отслеживание

## CI/CD Pipeline

### GitHub Actions
- Автоматическая сборка Docker образов
- Тестирование на уровне сервисов
- Деплой в тестовое окружение
- Продакшн деплой с возможностью отката

## Масштабирование

### Горизонтальное масштабирование
- Каждый сервис может масштабироваться независимо
- Использование Kubernetes для оркестрации
- Auto-scaling на основе метрик

### Базы данных
- Использование отдельных баз данных для каждого сервиса
- Возможность шардинга для высоконагруженных сервисов
- Репликация для обеспечения доступности

## Технический стек

### Backend
- FastAPI (Python) - основной фреймворк
- PostgreSQL - основная база данных
- Redis - кэш и очереди
- Kafka - шина сообщений

### Инфраструктура
- Docker - контейнеризация
- Kubernetes - оркестрация
- Consul - service discovery
- Traefik - ingress controller
- Prometheus - мониторинг

### Тестирование
- Pytest - модульное тестирование
- TestContainers - интеграционное тестирование
- Chaos Engineering - тестирование отказоустойчивости